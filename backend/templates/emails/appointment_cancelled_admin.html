{% extends "emails/base_email.html" %}

{% block title %}預約取消通知 - 心理諮商預約系統{% endblock %}

{% block header_title %}🚫 預約取消通知{% endblock %}
{% block header_subtitle %}<p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">有用戶取消了預約申請</p>{% endblock %}

{% block greeting %}
<p>親愛的管理員，您好：</p>
{% endblock %}

{% block content %}
<div class="alert warning">
    <strong>⚠️ 預約取消通知</strong><br>
    用戶已主動取消預約申請，相關時段現已釋放可供其他用戶預約。
</div>

<p>以下是取消的預約詳細資訊：</p>
{% endblock %}

{% block appointment_details %}
<div class="appointment-card" style="border-left: 4px solid #f56565;">
    <h3 style="margin-top: 0; color: #e53e3e;">❌ 已取消的預約</h3>
    
    <div class="appointment-detail">
        <span class="detail-label">預約編號：</span>
        <span class="detail-value"><strong style="color: #e53e3e;">#{{ appointment.id }}</strong></span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">用戶姓名：</span>
        <span class="detail-value">{{ appointment.detail.name }}</span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">聯絡電話：</span>
        <span class="detail-value">{{ appointment.detail.phone }}</span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">電子郵件：</span>
        <span class="detail-value">{{ appointment.user.email }}</span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">指定心理師：</span>
        <span class="detail-value">{{ appointment.therapist.name }}</span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">原申請時間：</span>
        <span class="detail-value">{{ appointment.created_at|date:"Y年m月d日 H:i" }}</span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">取消時間：</span>
        <span class="detail-value"><strong>{{ appointment.updated_at|date:"Y年m月d日 H:i" }}</strong></span>
    </div>
    
    <div class="appointment-detail">
        <span class="detail-label">原狀態：</span>
        <span class="detail-value">
            {% if appointment.status == 'cancelled' %}
                <span style="background-color: #fed7d7; color: #9b2c2c; padding: 4px 12px; border-radius: 15px; font-size: 12px;">
                    ❌ 已取消
                </span>
            {% endif %}
        </span>
    </div>
</div>

<div class="appointment-card">
    <h3 style="margin-top: 0; color: #667eea;">原預約偏好時段</h3>
    {% for period in appointment.preferred_periods.all %}
    <div class="appointment-detail">
        <span class="detail-label">時段 {{ forloop.counter }}：</span>
        <span class="detail-value">
            {{ period.date|date:"Y年m月d日" }} 
            {% if period.period == 'morning' %}上午 (09:00-12:00)
            {% elif period.period == 'afternoon' %}下午 (13:00-17:00)
            {% elif period.period == 'evening' %}晚上 (18:00-21:00)
            {% endif %}
            <span style="color: #48bb78; font-weight: bold;">✅ 已釋放</span>
        </span>
    </div>
    {% endfor %}
</div>

{% if appointment.slot %}
<div class="appointment-card" style="border-left: 4px solid #48bb78; background-color: #f0fff4;">
    <h3 style="margin-top: 0; color: #22543d;">🔄 時段狀態更新</h3>
    <div class="appointment-detail">
        <span class="detail-label">已確認時段：</span>
        <span class="detail-value">
            {{ appointment.slot.slot_time|date:"Y年m月d日 H:i" }}
            <span style="background-color: #c6f6d5; color: #22543d; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">
                已自動釋放
            </span>
        </span>
    </div>
    <p style="margin: 10px 0 0 0; padding: 10px; background-color: white; border-radius: 4px; color: #22543d; font-size: 14px;">
        ✅ 該時段現已可供其他用戶預約
    </p>
</div>
{% endif %}

{% if appointment.detail.main_concerns %}
<div class="appointment-card">
    <h3 style="margin-top: 0; color: #667eea;">原主要困擾</h3>
    <p style="margin: 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e2e8f0; color: #666;">
        {{ appointment.detail.main_concerns }}
    </p>
</div>
{% endif %}
{% endblock %}

{% block actions %}
<div style="text-align: center; margin: 30px 0;">
    <p><strong>📊 需要處理的事項</strong></p>
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <div style="display: flex; gap: 20px; justify-content: space-around; flex-wrap: wrap;">
            <div style="text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">✅</div>
                <div style="font-size: 12px; color: #666;">時段已自動釋放</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">📊</div>
                <div style="font-size: 12px; color: #666;">統計已自動更新</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">📝</div>
                <div style="font-size: 12px; color: #666;">記錄已保存</div>
            </div>
        </div>
    </div>
    <a href="{{ admin_url }}" class="button secondary">查看管理後台</a>
</div>
{% endblock %}

{% block additional_info %}
<div class="divider"></div>

<div style="display: flex; gap: 20px; margin: 20px 0;">
    <div style="flex: 1; background-color: #ebf8ff; padding: 20px; border-radius: 6px; border: 1px solid #90cdf4;">
        <h4 style="margin-top: 0; color: #2a4365;">📈 系統自動處理</h4>
        <ul style="margin: 10px 0; padding-left: 20px; color: #2a4365; line-height: 1.6;">
            <li>預約狀態已更新為「已取消」</li>
            <li>相關時段已釋放</li>
            <li>統計數據已自動調整</li>
            <li>通知用戶取消成功</li>
        </ul>
    </div>
    <div style="flex: 1; background-color: #f0fff4; padding: 20px; border-radius: 6px; border: 1px solid #9ae6b4;">
        <h4 style="margin-top: 0; color: #22543d;">💡 建議動作</h4>
        <ul style="margin: 10px 0; padding-left: 20px; color: #22543d; line-height: 1.6;">
            <li>檢查是否有候補名單</li>
            <li>評估取消原因（如適用）</li>
            <li>更新心理師行程</li>
            <li>追蹤用戶後續需求</li>
        </ul>
    </div>
</div>

<div class="alert info">
    <strong>📊 取消統計摘要</strong><br>
    <div style="margin-top: 15px; line-height: 1.6;">
        • 取消時間：<strong>{{ appointment.updated_at|date:"Y年m月d日 H:i" }}</strong><br>
        • 原狀態：<strong>{{ appointment.get_status_display }}</strong> → 已取消<br>
        • 處理方式：<strong>用戶主動取消</strong><br>
        • 影響範圍：<strong>時段已釋放，可供重新預約</strong>
    </div>
</div>

<div class="alert warning">
    <strong>⚠️ 注意事項</strong><br>
    • 如該時段已有候補用戶，請主動聯繫安排<br>
    • 建議檢查心理師當日行程是否需要調整<br>
    • 取消記錄已保存，可用於後續分析<br>
    • 如用戶頻繁取消，可評估是否需要特別關注
</div>

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; margin: 30px 0; text-align: center;">
    <h3 style="margin: 0 0 15px 0;">🔄 系統運作正常</h3>
    <p style="margin: 0; font-size: 16px; opacity: 0.9;">
        預約取消已妥善處理，相關資源已釋放，<br>
        系統持續為其他用戶提供優質服務。
    </p>
</div>
{% endblock %}

{% block footer %}
<p>系統已自動處理此次取消，無需額外操作。</p>
<div class="footer-links">
    <a href="{{ admin_url }}">管理後台</a>
    <a href="#">預約統計</a>
    <a href="#">系統設定</a>
</div>
<p>&copy; 2025 心理諮商預約系統. 保留所有權利。</p>
{% endblock %}