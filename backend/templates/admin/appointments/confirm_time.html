{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-main">
    <h1>{{ title }}</h1>
    
    <!-- 預約基本資訊 -->
    <div class="module aligned wide">
        <h2>預約資訊</h2>
        <div class="form-row">
            <div>
                <strong>用戶：</strong> 
                {% if appointment.detail.name %}
                    {{ appointment.detail.name }} ({{ appointment.user.email }})
                {% else %}
                    {{ appointment.user.email }}
                {% endif %}
            </div>
        </div>
        <div class="form-row">
            <div><strong>心理師：</strong> {{ appointment.therapist.name }}</div>
        </div>
        <div class="form-row">
            <div><strong>諮商方式：</strong> {{ appointment.get_consultation_type_display }}</div>
        </div>
    </div>

    <!-- 偏好時段 -->
    <div class="module aligned wide">
        <h2>用戶偏好時段</h2>
        {% if preferred_periods %}
        <table>
            <thead>
                <tr>
                    <th>日期</th>
                    <th>時段</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for period in preferred_periods %}
                <tr>
                    <td>{{ period.date }}</td>
                    <td>{{ period.get_period_display }}</td>
                    <td>
                        <button type="button" 
                                class="button small" 
                                onclick="selectPreferredTime('{{ period.date|date:'Y-m-d' }}', '{{ period.period }}')"
                                data-date="{{ period.date|date:'Y-m-d' }}"
                                data-period="{{ period.period }}"
                                title="點擊設定此時段為預約時間">
                            選擇此時段
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>用戶未提供偏好時段</p>
        {% endif %}
    </div>

    <!-- 確認時間表單 -->
    <form method="post">
        {% csrf_token %}
        <div class="module aligned wide">
            <h2>確認具體時間</h2>
            <div class="form-row">
                <div>
                    <label for="confirmed_datetime">確認時間：</label>
                    <input type="datetime-local" name="confirmed_datetime" id="confirmed_datetime" required>
                    <p class="help">請選擇具體的預約時間（格式：YYYY-MM-DD HH:MM）</p>
                </div>
            </div>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="確認時間" class="default" />
            <a href="{% url 'admin:appointments_appointment_changelist' %}" class="button cancel-link">取消</a>
        </div>
    </form>
</div>

<script>
function selectPreferredTime(date, period) {
    console.log('selectPreferredTime called with:', date, period);
    
    // 根據時段設定建議時間
    let time = '';
    switch(period) {
        case 'morning':
            time = '09:00';
            break;
        case 'afternoon':
            time = '14:00';
            break;
        case 'evening':
            time = '19:00';
            break;
        default:
            time = '09:00';
    }
    
    console.log('Calculated time:', time);
    
    // 設定日期時間輸入框的值 (日期已經是ISO格式 YYYY-MM-DD)
    const datetimeInput = document.getElementById('confirmed_datetime');
    if (datetimeInput) {
        const dateTimeValue = date + 'T' + time;
        console.log('Setting datetime input to:', dateTimeValue);
        datetimeInput.value = dateTimeValue;
        
        // 觸發change事件以確保表單知道值已改變
        datetimeInput.dispatchEvent(new Event('change'));
        
        // 視覺回饋：輸入框短暫變綠
        datetimeInput.style.backgroundColor = '#e6ffe6';
        setTimeout(() => {
            datetimeInput.style.backgroundColor = '';
        }, 1000);
        
        console.log('Datetime input value successfully set to:', datetimeInput.value);
        
        // 滾動到輸入框位置
        datetimeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 聚焦到輸入框
        datetimeInput.focus();
    } else {
        console.error('confirmed_datetime input not found!');
    }
}

// 設定最小日期為今天並添加事件監聽器
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up datetime input...');
    
    const now = new Date();
    const today = now.toISOString().slice(0, 16);
    const datetimeInput = document.getElementById('confirmed_datetime');
    
    if (datetimeInput) {
        datetimeInput.min = today;
        console.log('Set min datetime to:', today);
    } else {
        console.error('confirmed_datetime input not found during DOMContentLoaded!');
    }
    
    // 為所有按鈕添加事件監聽器作為備用方案
    const buttons = document.querySelectorAll('button[data-date][data-period]');
    console.log('Found', buttons.length, 'time selection buttons');
    
    buttons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const date = this.dataset.date;
            const period = this.dataset.period;
            console.log('Button clicked via event listener:', date, period);
            selectPreferredTime(date, period);
        });
    });
});

// 測試函數 - 可在瀏覽器控制台調用
function testSelectTime() {
    console.log('Testing selectPreferredTime function...');
    selectPreferredTime('2024-01-15', 'afternoon');
}
</script>

<style>
.module table {
    width: 100%;
    border-collapse: collapse;
}

.module table th,
.module table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
}

.module table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.button.small {
    padding: 5px 10px;
    font-size: 12px;
}
</style>
{% endblock %}