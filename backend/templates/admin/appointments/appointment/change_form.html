{% extends "admin/change_form.html" %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
(function($) {
    // è«®å•†å®¤é¸é …é…ç½®
    const roomOptions = {
        'online': [
            {value: '', text: '---------'},
            {value: 'online_room', text: 'ç·šä¸Šæœƒè­°å®¤'}
        ],
        'offline': [
            {value: '', text: '---------'},
            {value: 'room_2', text: 'è«®å•†å®¤ 2'},
            {value: 'room_3', text: 'è«®å•†å®¤ 3'},
            {value: 'room_4', text: 'è«®å•†å®¤ 4'},
            {value: 'room_5', text: 'è«®å•†å®¤ 5'}
        ]
    };
    
    function updateRoomOptions() {
        const consultationType = $('#id_consultation_type').val();
        const roomSelect = $('#id_consultation_room');
        const currentValue = roomSelect.val();
        
        // æ¸…ç©ºç¾æœ‰é¸é …
        roomSelect.empty();
        
        // æ ¹æ“šè«®å•†é¡å‹æ·»åŠ å°æ‡‰é¸é …
        if (roomOptions[consultationType]) {
            roomOptions[consultationType].forEach(function(option) {
                roomSelect.append(
                    $('<option></option>').attr('value', option.value).text(option.text)
                );
            });
            
            // å˜—è©¦ä¿ç•™åŸå§‹é¸æ“‡ï¼ˆå¦‚æœä»ç„¶æœ‰æ•ˆï¼‰
            if (currentValue && roomSelect.find('option[value="' + currentValue + '"]').length > 0) {
                roomSelect.val(currentValue);
            }
            
            // å•Ÿç”¨è«®å•†å®¤é¸æ“‡
            roomSelect.prop('disabled', false);
        } else {
            // å¦‚æœæ²’æœ‰å°æ‡‰çš„è«®å•†é¡å‹ï¼Œé¡¯ç¤ºæç¤º
            roomSelect.append('<option value="">è«‹å…ˆé¸æ“‡è«®å•†æ–¹å¼</option>');
            roomSelect.prop('disabled', true);
        }
    }
    
    // ç›£è½è«®å•†é¡å‹è®ŠåŒ–
    $('#id_consultation_type').change(updateRoomOptions);
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    updateRoomOptions();
    
    // ç‚ºå‚™è¨»æ¬„ä½æ·»åŠ å­—æ•¸çµ±è¨ˆ
    const notesField = $('#id_admin_notes');
    if (notesField.length > 0) {
        // å‰µå»ºå­—æ•¸çµ±è¨ˆé¡¯ç¤ºå…ƒç´ 
        const counterHtml = '<div id="notes-counter" style="margin-top: 5px; color: #666; font-size: 12px;">å­—æ•¸: <span id="notes-count">0</span></div>';
        notesField.after(counterHtml);
        
        function updateCounter() {
            const count = notesField.val().length;
            $('#notes-count').text(count);
            
            // è¶…éå»ºè­°é•·åº¦æ™‚æ”¹è®Šé¡è‰²
            if (count > 500) {
                $('#notes-counter').css('color', '#e74c3c');
            } else if (count > 300) {
                $('#notes-counter').css('color', '#f39c12');
            } else {
                $('#notes-counter').css('color', '#666');
            }
        }
        
        // ç›£è½è¼¸å…¥äº‹ä»¶
        notesField.on('input', updateCounter);
        
        // åˆå§‹åŒ–å­—æ•¸çµ±è¨ˆ
        updateCounter();
    }
    
})(django.jQuery);
</script>

<style>
/* å„ªåŒ–è«®å•†å®‰æ’å€å¡Šçš„æ¨£å¼ */
.form-row .field-consultation_room {
    margin-bottom: 15px;
}

.form-row .field-admin_notes {
    margin-bottom: 10px;
}

.field-admin_notes textarea {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 13px;
    line-height: 1.4;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
}

.field-admin_notes textarea:focus {
    border-color: #417690;
    outline: none;
    box-shadow: 0 0 5px rgba(65, 118, 144, 0.3);
}

/* è«®å•†å®¤é¸æ“‡çš„æ¨£å¼ */
.field-consultation_room select {
    min-width: 200px;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
}

.field-consultation_room select:disabled {
    background-color: #f5f5f5;
    color: #999;
}

/* ç‚ºè«®å•†å®‰æ’fieldsetæ·»åŠ åœ–æ¨™ */
.module h2:contains('è«®å•†å®‰æ’')::before {
    content: 'ğŸ¢ ';
}
</style>
{% endblock %}