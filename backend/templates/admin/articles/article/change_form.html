{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // 等待CKEditor載入
    setTimeout(function() {
        if (typeof CKEDITOR !== 'undefined') {
            // 簡單且安全的對話框修復
            CKEDITOR.on('dialogDefinition', function(ev) {
                var dialogName = ev.data.name;
                var dialogDefinition = ev.data.definition;
                
                if (dialogName == 'image') {
                    // 儲存原始的onOk和onCancel方法
                    var originalOnOk = dialogDefinition.onOk;
                    var originalOnCancel = dialogDefinition.onCancel;
                    
                    // 重寫onOk方法
                    dialogDefinition.onOk = function() {
                        try {
                            var result = originalOnOk && originalOnOk.call(this);
                            
                            // 自動調整插入圖片的大小
                            var self = this;
                            setTimeout(function() {
                                try {
                                    var editor = self._.editor;
                                    var selection = editor.getSelection();
                                    var element = selection.getSelectedElement();
                                    
                                    if (element && element.is('img')) {
                                        // 設定預設最大寬度和樣式
                                        element.setStyle('max-width', '600px');
                                        element.setStyle('height', 'auto');
                                        element.setStyle('display', 'block');
                                        element.setStyle('margin', '16px auto');
                                        element.setStyle('border-radius', '8px');
                                        element.setStyle('box-shadow', '0 2px 8px rgba(0, 0, 0, 0.1)');
                                        
                                        // 添加預設class
                                        element.addClass('img-center');
                                    }
                                    
                                    if (CKEDITOR.dialog.getCurrent()) {
                                        CKEDITOR.dialog.getCurrent().hide();
                                    }
                                } catch(e) {
                                    console.log('Dialog close handled');
                                }
                            }, 50);
                            return result;
                        } catch(e) {
                            console.log('OK button handled');
                            return false;
                        }
                    };
                    
                    // 重寫onCancel方法 - 直接調用onOk來儲存
                    dialogDefinition.onCancel = function() {
                        try {
                            // 先執行OK邏輯來儲存
                            if (originalOnOk) {
                                originalOnOk.call(this);
                            }
                            
                            // 然後關閉對話框
                            var self = this;
                            setTimeout(function() {
                                try {
                                    if (CKEDITOR.dialog.getCurrent()) {
                                        CKEDITOR.dialog.getCurrent().hide();
                                    }
                                } catch(e) {
                                    console.log('Dialog close handled');
                                }
                            }, 50);
                            
                            return false; // 阻止預設的取消行為
                        } catch(e) {
                            console.log('Cancel button handled');
                            return false;
                        }
                    };
                    
                    // 禁用dirty檢查
                    dialogDefinition.onShow = function() {
                        var self = this;
                        setTimeout(function() {
                            try {
                                // 禁用所有dirty檢查
                                self.foreach(function(element) {
                                    if (element.isDirty) {
                                        element.isDirty = function() { return false; };
                                    }
                                });
                                
                                // 禁用對話框級別的dirty檢查
                                if (self.checkDirty) {
                                    self.checkDirty = function() { return false; };
                                }
                            } catch(e) {
                                console.log('Dirty check disabled');
                            }
                        }, 100);
                    };
                }
            });
            
            // ESC鍵處理
            CKEDITOR.on('instanceReady', function(ev) {
                var editor = ev.editor;
                
                editor.on('key', function(event) {
                    if (event.data.keyCode === 27) { // ESC key
                        try {
                            var dialog = CKEDITOR.dialog.getCurrent();
                            if (dialog && dialog.getName() === 'image') {
                                // 觸發取消按鈕（會自動儲存）
                                var cancelBtn = dialog.getButton('cancel');
                                if (cancelBtn) {
                                    setTimeout(function() {
                                        try {
                                            cancelBtn.click();
                                        } catch(e) {
                                            // 如果點擊失敗，直接關閉
                                            dialog.hide();
                                        }
                                    }, 10);
                                }
                            }
                        } catch(e) {
                            console.log('ESC key handled');
                        }
                    }
                });
            });
        }
    }, 1000);
});
</script>

<style>
/* 確保對話框樣式正確 */
.cke_dialog {
    z-index: 10001 !important;
}
.cke_dialog_background_cover {
    z-index: 10000 !important;
}
/* 修復對話框按鈕樣式 */
.cke_dialog_footer_buttons {
    text-align: right !important;
}
.cke_dialog_footer_buttons .cke_dialog_ui_button {
    margin: 0 5px !important;
}
</style>
{% endblock %}