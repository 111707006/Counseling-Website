{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-main">
    <h1>{{ title }}</h1>
    
    <!-- 預約基本資訊 -->
    <div class="module aligned wide">
        <h2>預約資訊</h2>
        <div class="form-row">
            <div>
                <strong>用戶：</strong> 
                {% if appointment.detail.name %}
                    {{ appointment.detail.name }} ({{ appointment.user.email }})
                {% else %}
                    {{ appointment.user.email }}
                {% endif %}
            </div>
        </div>
        <div class="form-row">
            <div><strong>諮商方式：</strong> {{ appointment.get_consultation_type_display }}</div>
        </div>
        <div class="form-row">
            <div><strong>建立時間：</strong> {{ appointment.created_at }}</div>
        </div>
        {% if appointment.detail.main_concerns %}
        <div class="form-row">
            <div><strong>主要關注議題：</strong> {{ appointment.detail.main_concerns }}</div>
        </div>
        {% endif %}
    </div>

    <!-- 推薦心理師 -->
    {% if recommended_therapists %}
    <div class="module aligned wide">
        <h2>推薦心理師（專業匹配）</h2>
        <p>以下心理師具有用戶需求的專業領域：</p>
        <ul>
            {% for therapist in recommended_therapists %}
            <li>
                <strong>{{ therapist.name }}</strong> - {{ therapist.title }}
                <br>專長：{{ therapist.get_specialties_display }}
                <br>收費：
                {% for mode, price in therapist.pricing.items %}
                    {{ mode }}: NT${{ price }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- 分配表單 -->
    <form method="post">
        {% csrf_token %}
        <div class="module aligned wide">
            <h2>選擇心理師</h2>
            <div class="form-row">
                <div>
                    <label for="therapist">心理師：</label>
                    <select name="therapist" id="therapist" required>
                        <option value="">請選擇心理師</option>
                        {% for therapist in available_therapists %}
                        <option value="{{ therapist.id }}">
                            {{ therapist.name }} - {{ therapist.title }}
                            ({{ therapist.consultation_modes|join:", " }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="分配心理師" class="default" />
            <a href="{% url 'admin:appointments_appointment_change' appointment.id %}" class="button cancel-link">取消</a>
        </div>
    </form>
</div>

<script>
// 顯示心理師詳細資訊
document.getElementById('therapist').addEventListener('change', function() {
    const therapistId = this.value;
    if (therapistId) {
        // 這裡可以添加 AJAX 請求來顯示心理師的詳細資訊
        console.log('Selected therapist:', therapistId);
    }
});
</script>
{% endblock %}