{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-main">
    <h1>{{ title }}</h1>
    
    <!-- 預約基本資訊 -->
    <div class="module aligned wide">
        <h2>預約資訊</h2>
        <div class="form-row">
            <div>
                <strong>用戶：</strong> 
                {% if appointment.detail.name %}
                    {{ appointment.detail.name }} ({{ appointment.user.email }})
                {% else %}
                    {{ appointment.user.email }}
                {% endif %}
            </div>
        </div>
        <div class="form-row">
            <div><strong>心理師：</strong> {{ appointment.therapist.name }}</div>
        </div>
        <div class="form-row">
            <div><strong>諮商方式：</strong> {{ appointment.get_consultation_type_display }}</div>
        </div>
    </div>

    <!-- 偏好時段 -->
    <div class="module aligned wide">
        <h2>用戶偏好時段</h2>
        {% if preferred_periods %}
        <table>
            <thead>
                <tr>
                    <th>日期</th>
                    <th>時段</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for period in preferred_periods %}
                <tr>
                    <td>{{ period.date }}</td>
                    <td>{{ period.get_period_display }}</td>
                    <td>
                        <button type="button" class="button small" onclick="selectPreferredTime('{{ period.date }}', '{{ period.period }}')">
                            選擇此時段
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>用戶未提供偏好時段</p>
        {% endif %}
    </div>

    <!-- 確認時間表單 -->
    <form method="post">
        {% csrf_token %}
        <div class="module aligned wide">
            <h2>確認具體時間</h2>
            <div class="form-row">
                <div>
                    <label for="confirmed_datetime">確認時間：</label>
                    <input type="datetime-local" name="confirmed_datetime" id="confirmed_datetime" required>
                    <p class="help">請選擇具體的預約時間（格式：YYYY-MM-DD HH:MM）</p>
                </div>
            </div>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="確認時間" class="default" />
            <a href="{% url 'admin:appointments_appointment_change' appointment.id %}" class="button cancel-link">取消</a>
        </div>
    </form>
</div>

<script>
function selectPreferredTime(date, period) {
    // 根據時段設定建議時間
    let time = '';
    switch(period) {
        case 'morning':
            time = '09:00';
            break;
        case 'afternoon':
            time = '14:00';
            break;
        case 'evening':
            time = '19:00';
            break;
        default:
            time = '09:00';
    }
    
    // 設定日期時間輸入框的值
    const datetimeInput = document.getElementById('confirmed_datetime');
    datetimeInput.value = date + 'T' + time;
}

// 設定最小日期為今天
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const today = now.toISOString().slice(0, 16);
    document.getElementById('confirmed_datetime').min = today;
});
</script>

<style>
.module table {
    width: 100%;
    border-collapse: collapse;
}

.module table th,
.module table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
}

.module table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.button.small {
    padding: 5px 10px;
    font-size: 12px;
}
</style>
{% endblock %}